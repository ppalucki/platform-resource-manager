pipeline {
	/* Disable temporarily */
    /* triggers { cron('H/30 * * * *') } */
    agent { label 'mesos' }
    environment {
        PLAYBOOK='prm/workload-collocation-agent/workloads/run_workloads.yaml'
        INVENTORY='prm/demo_scenarios/common/inventory.yaml'
        PROMETHEUS='http://100.64.176.12:9090' 
        MESOS_MASTER_HOST='100.64.176.23'
		/* --- */
        LLC_INVENTORY='prm/demo_scenarios/complex_llc.0/inventory.yaml'
        LLC_BASELINE_SLEEP = 300
        LLC_COLLECT_SLEEP = 120
        LLC_CONTENDER_SLEEP = 120
		/* --- */
        MBW_INVENTORY='prm/demo_scenarios/complex_mbw.0/inventory.yaml'
        MBW_BASELINE_SLEEP = 120
        MBW_COLLECT_SLEEP = 120
        MBW_CONTENDER_SLEEP = 120
		/* --- */
        BUILD_COMMIT = "${GIT_COMMIT}"
        EXTRA_ANSIBLE_PARAMS = ""
    }
    options {
        disableConcurrentBuilds()
        timeout(time: 1200, unit: 'MINUTES')
    }
    parameters {
        booleanParam(name: 'BUILD_PEX', defaultValue: true, description: 'Build wca-pex')
		/* --- */
        booleanParam(name: 'BUILD_LLC_MODEL', defaultValue: false, description: 'Build Model For LLC Contention')
        booleanParam(name: 'LLC', defaultValue: true, description: 'Run LLC experiment')
		/* --- */
        booleanParam(name: 'BUILD_MBW_MODEL', defaultValue: false, description: 'Build Model For MBWÂ Contention')
        booleanParam(name: 'MBW', defaultValue: false, description: 'Run MBW experiment')
    }
    stages {
        stage('Build pex') {
            when { expression { return params.BUILD_PEX } }
            stages {
                stage("Prepare venv && build pex") {
                    steps {
                        dir('prm') {
                            sh('make venv')
                            // sh('make check')
                            sh('make package')
                        }
                    }
                }
            }
        }
        stage("Prepare aurora cluster") {
            when { expression { return params.MBW | params.LLC} }
            steps {
                sh'''
                mkdir -p ${HOME}/.aurora
                cp ${WORKSPACE}/prm/demo_scenarios/common/aurora-clusters.json  ${HOME}/.aurora/clusters.json
                '''
            }
        }

        stage("Build model for LLC") {
            when { expression { return params.BUILD_LLC_MODEL } }
            environment {
                MESOS_EXPECTED_TASKS = -1
                BUILD_SCENARIO = "llc"
                LABELS="{additional_labels: {build_number: \"${BUILD_NUMBER}\", build_node_name: \"${NODE_NAME}\", build_commit: \"${GIT_COMMIT}\", build_scenario: \"$BUILD_SCENARIO\"}}"
            }
            steps {
                echo 'Reconfigure wca...'
                sh 'cp ${WORKSPACE}/prm/demo_scenarios/common/wca_config.collect.yml ${WORKSPACE}/prm/demo_scenarios/common/wca_config.yml.tmp'
                contentReplace(
                    configs: [
                        fileContentReplaceConfig(
                            configs: [
                                fileContentReplaceItemConfig( search: 'BUILD_COMMIT', replace: "${GIT_COMMIT}", matchCount: 0),
                                fileContentReplaceItemConfig( search: 'BUILD_NUMBER', replace: "${BUILD_NUMBER}", matchCount: 0),
                                fileContentReplaceItemConfig( search: 'BUILD_SCENARIO', replace: "${BUILD_SCENARIO}", matchCount: 0)
                            ],
                            fileEncoding: 'UTF-8', 
                            filePath: "${WORKSPACE}/prm/demo_scenarios/common/wca_config.yml.tmp")
                        ])
                sh'''
                sudo cp ${WORKSPACE}/prm/demo_scenarios/common/workload.json /var/lib/wca/
                sudo cp ${WORKSPACE}/prm/demo_scenarios/common/wca_config.yml.tmp /etc/wca/wca_config.yml
                sudo cp ${WORKSPACE}/prm/dist/wca-prm.pex /usr/bin/wca.pex
                sudo systemctl restart wca
                '''
                echo 'Restart wca...'
                sleep 5
                sh 'sudo systemctl status wca'

                dir('prm/workload-collocation-agent/workloads'){
                    echo 'Start baseline workloads.'
                    sh 'ansible-playbook ${EXTRA_ANSIBLE_PARAMS} -i ${WORKSPACE}/${LLC_INVENTORY} -i ${WORKSPACE}/${INVENTORY} --tags=twemcache_mutilate,redis_rpc_perf,cassandra_stress--cassandra,stress_ng -e "${LABELS}" ${WORKSPACE}/${PLAYBOOK}'
                    sleep LLC_COLLECT_SLEEP
                }
            }
            post {
                always {
                    echo 'Stop all workloads...'
                    sh 'ansible-playbook  ${EXTRA_ANSIBLE_PARAMS}  -i ${WORKSPACE}/${INVENTORY} --tags=clean_jobs ${WORKSPACE}/${PLAYBOOK}'
                    echo 'Stop wca...'
                    sh 'sudo systemctl stop wca'
                }
            }
        }
        stage("Run LLC experiment") {
            when { expression { return params.LLC } }
            environment {
                MESOS_EXPECTED_TASKS = -1
                MIN_RECALL = -1
                MIN_PRECISION = -1
                BUILD_SCENARIO = "llc"
                LABELS="{additional_labels: {build_number: \"${BUILD_NUMBER}\", build_node_name: \"${NODE_NAME}\", build_commit: \"${GIT_COMMIT}\", build_scenario: \"$BUILD_SCENARIO\"}}"
            }
            steps {
                echo 'Reconfigure wca...'
                sh 'cp ${WORKSPACE}/prm/demo_scenarios/common/wca_config.yml ${WORKSPACE}/prm/demo_scenarios/common/wca_config.yml.tmp'
                contentReplace(
                    configs: [
                        fileContentReplaceConfig(
                            configs: [
                                fileContentReplaceItemConfig( search: 'BUILD_COMMIT', replace: "${GIT_COMMIT}", matchCount: 0),
                                fileContentReplaceItemConfig( search: 'BUILD_NUMBER', replace: "${BUILD_NUMBER}", matchCount: 0),
                                fileContentReplaceItemConfig( search: 'BUILD_SCENARIO', replace: "${BUILD_SCENARIO}", matchCount: 0)
                            ],
                            fileEncoding: 'UTF-8', 
                            filePath: "${WORKSPACE}/prm/demo_scenarios/common/wca_config.yml.tmp")
                        ])
                sh'''
                sudo cp ${WORKSPACE}/prm/demo_scenarios/common/workload.json /var/lib/wca/
                sudo cp ${WORKSPACE}/prm/demo_scenarios/common/wca_config.yml.tmp /etc/wca/wca_config.yml
                sudo cp ${WORKSPACE}/prm/dist/wca-prm.pex /usr/bin/wca.pex
                sudo systemctl restart wca
                '''
                echo 'Restart wca...'
                sleep 2
                sh 'sudo systemctl status wca'

                dir('prm/workload-collocation-agent/workloads'){
                    echo 'Start baseline workloads.'
                    sh 'ansible-playbook ${EXTRA_ANSIBLE_PARAMS} -i ${WORKSPACE}/${LLC_INVENTORY} -i ${WORKSPACE}/${INVENTORY} --tags=twemcache_mutilate,redis_rpc_perf,cassandra_stress--cassandra,stress_ng -e "${LABELS}" ${WORKSPACE}/${PLAYBOOK}'
                    sleep LLC_BASELINE_SLEEP
                    echo 'Start contender workload.'
                    sh 'ansible-playbook  ${EXTRA_ANSIBLE_PARAMS}  -i ${WORKSPACE}/${LLC_INVENTORY} -i ${WORKSPACE}/${INVENTORY} --tags=cassandra_stress--stress -e "${LABELS}" ${WORKSPACE}/${PLAYBOOK}'
                    sleep LLC_CONTENDER_SLEEP
                }
                dir('prm'){
                    echo 'Calculate precision and recall...'
                    sh "PYTHONPATH=. pipenv run pytest tests/e2e/test_calculate_accuracy.py --junitxml=unit_results.xml --junit-prefix=${BUILD_SCENARIO} --log-level=debug --log-cli-level=debug -v"
                }
            }
            post {
                always {
                    echo 'Stop all workloads...'
                    sh 'ansible-playbook  ${EXTRA_ANSIBLE_PARAMS}  -i ${WORKSPACE}/${INVENTORY} --tags=clean_jobs ${WORKSPACE}/${PLAYBOOK}'
                    sleep 5
                    echo 'Plot LLC results...'
                    plot(
                        csvFileName: 'llc_results.csv',
                        style: 'line',
                        csvSeries: [
                            [
                                displayTableFlag: false,
                                exclusionValues: '',
                                inclusionFlag: 'OFF',
                                file: 'prm/test_results.csv',
                                url: ''
                            ]
                        ],
                       group: 'PRM performance v4',
                       title: 'LLC complex scenario',
                       numBuilds: '5',
                    )
                    echo 'Storing LLC results.'
                    junit 'prm/unit_results.xml'
                    echo 'Stop wca...'
                    sh 'sudo systemctl stop wca'
                }
            }
        }

		stage("Build model for Memory Bandwidth.") {
            when { expression { return params.BUILD_MBW_MODEL } }
			steps {
				echo 'Building model for MBW is not yet implemented'
				/* TODO Add code to build MBW model. */
			}
		}
        stage("Run Memory Bandwidth experiment") {
            when {
                expression { return params.MBW }
            }
            environment {
                MESOS_EXPECTED_TASKS = -1
                MIN_RECALL = -1
                MIN_PRECISION = -1
                BUILD_SCENARIO = "mbw"
                LABELS="{additional_labels: {build_number: \"${BUILD_NUMBER}\", build_node_name: \"${NODE_NAME}\", build_commit: \"${GIT_COMMIT}\", build_scenario: \"$BUILD_SCENARIO\"}}"
            }
            steps {
                echo 'Reconfigure wca...'
				sh 'cp ${WORKSPACE}/prm/demo_scenarios/common/wca_config.yml ${WORKSPACE}/prm/demo_scenarios/common/wca_config.yml.tmp'
                contentReplace(
                    configs: [
                        fileContentReplaceConfig(
                            configs: [
                                fileContentReplaceItemConfig( search: 'BUILD_COMMIT', replace: "${GIT_COMMIT}", matchCount: 0),
                                fileContentReplaceItemConfig( search: 'BUILD_NUMBER', replace: "${BUILD_NUMBER}", matchCount: 0),
                                fileContentReplaceItemConfig( search: 'BUILD_SCENARIO', replace: "${BUILD_SCENARIO}", matchCount: 0)
                            ],
                            fileEncoding: 'UTF-8', 
                            filePath: "${WORKSPACE}/prm/demo_scenarios/common/wca_config.yml.tmp")
                        ])
                sh'''
                sudo cp ${WORKSPACE}/prm/demo_scenarios/common/threshold.json /var/lib/wca/
                sudo cp ${WORKSPACE}/prm/demo_scenarios/common/workload.json /var/lib/wca/
                sudo cp ${WORKSPACE}/prm/demo_scenarios/common/wca_config.yml.tmp /etc/wca/wca_config.yml
                sudo cp ${WORKSPACE}/prm/dist/wca-prm.pex /usr/bin/wca.pex
                sudo systemctl restart wca
                '''
                sleep 5
                echo 'Restart wca...'
                sh 'sudo systemctl status wca'

                dir('prm/workload-collocation-agent/workloads'){
                    echo 'Start baseline workloads.'
                    sh 'ansible-playbook  ${EXTRA_ANSIBLE_PARAMS}  -i ${WORKSPACE}/${MBW_INVENTORY} -i ${WORKSPACE}/${INVENTORY} --tags=specjbb,tensorflow_benchmark_prediction,tensorflow_benchmark_train,cassandra_stress, stress_ng -e "${LABELS}" ${WORKSPACE}/${PLAYBOOK}'
                    sleep MBW_BASELINE_SLEEP
                    echo 'Start contender workload.'
                    sh 'ansible-playbook  ${EXTRA_ANSIBLE_PARAMS}  -i ${WORKSPACE}/${MBW_INVENTORY} -i ${WORKSPACE}/${INVENTORY} --tags=tensorflow_benchmark_prediction -e "${LABELS}" ${WORKSPACE}/${PLAYBOOK}'
                    sleep MBW_CONTENDER_SLEEP
                }
                dir('prm'){
                    echo 'Calculate precision and recall...'
                    sh "PYTHONPATH=. pipenv run pytest tests/e2e/test_calculate_accuracy.py --junitxml=unit_results.xml --junit-prefix=${BUILD_SCENARIO} --log-level=debug --log-cli-level=debug -v"
                }
            }
            post {
                always {
                    echo 'Stop all workloads...'
                    sh 'ansible-playbook  ${EXTRA_ANSIBLE_PARAMS}  -i ${WORKSPACE}/${INVENTORY} --tags=clean_jobs ${WORKSPACE}/${PLAYBOOK}'
                    sleep 5
                    echo 'Plot LLC results...'
                    plot(
                        csvFileName: 'mbw_results.csv',
                        style: 'line',
                        csvSeries: [
                            [
                                displayTableFlag: false,
                                exclusionValues: '',
                                inclusionFlag: 'OFF',
                                file: 'prm/test_results.csv',
                                url: ''
                            ]
                        ],
                       group: 'PRM performance v4',
                       title: 'MBW complex scenario',
                       numBuilds: '5',
                    )
                    echo 'Storing MBW results.'
                    junit 'prm/unit_results.xml'
                    echo 'Stop wca...'
                    sh 'sudo systemctl stop wca'
                }
            }
        }
    }
}
